# Server Configuration - Use environment variables
server.port=${SERVER_PORT:8083}
spring.application.name=account-service

spring.cloud.compatibility-verifier.enabled=false

#core-bank
core-banking.base-url=http://localhost:8088

# Database Configuration - Use environment variables
spring.datasource.url=${SPRING_DATASOURCE_URL:jdbc:mysql://localhost:3306/account_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC}
spring.datasource.username=${SPRING_DATASOURCE_USERNAME:root}
spring.datasource.password=${SPRING_DATASOURCE_PASSWORD:123456}
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# JPA / Hibernate Configuration
spring.jpa.hibernate.ddl-auto=${SPRING_JPA_HIBERNATE_DDL_AUTO:update}
spring.jpa.show-sql=${SPRING_JPA_SHOW_SQL:true}
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect

# Logging Configuration
logging.level.org.springframework=${LOGGING_LEVEL_SPRING:INFO}
logging.level.com.example.accountservice=${LOGGING_LEVEL_ACCOUNT_SERVICE:DEBUG}

# Nacos Discovery Configuration
spring.cloud.nacos.discovery.server-addr=${NACOS_SERVER_ADDR:localhost:8848}
spring.cloud.nacos.discovery.namespace=${NACOS_NAMESPACE:klb-bank}
spring.cloud.nacos.discovery.group=${NACOS_GROUP:banking-services}

# Feign Configuration
spring.cloud.openfeign.client.config.default.connect-timeout=5000
spring.cloud.openfeign.client.config.default.read-timeout=5000

# Feign Client URLs
spring.cloud.openfeign.client.config.customer-service.url=http://localhost:8082
spring.cloud.openfeign.client.config.core-banking-service.url=http://localhost:8088

# Dubbo Configuration (high-performance internal RPC)
dubbo.application.name=${DUBBO_APPLICATION_NAME:account-service}
dubbo.application.version=${DUBBO_APPLICATION_VERSION:1.0.0}
dubbo.application.logger=slf4j

# Dubbo Registry - Using Nacos
dubbo.registry.address=nacos://${NACOS_SERVER_ADDR:localhost:8848}
dubbo.registry.parameters.namespace=${NACOS_NAMESPACE:klb-bank}
dubbo.registry.parameters.group=${NACOS_GROUP:banking-services}

# Dubbo Protocol Configuration
dubbo.protocol.name=dubbo
dubbo.protocol.port=20881
dubbo.protocol.serialization=hessian2

# Dubbo Consumer Configuration
dubbo.consumer.timeout=${DUBBO_CONSUMER_TIMEOUT:5000}
dubbo.consumer.retries=${DUBBO_CONSUMER_RETRIES:2}
dubbo.consumer.check=${DUBBO_CONSUMER_CHECK:false}

dubbo.application.qos-enable=false
# Or use different port: dubbo.application.qos-port=22223

# Nacos Configuration Management - Use environment variables
nacos.config.server-addr=${NACOS_CONFIG_SERVER_ADDR:localhost:8848}
nacos.config.namespace=${NACOS_CONFIG_NAMESPACE:klb-bank}
nacos.config.group=${NACOS_CONFIG_GROUP:banking-services}
nacos.config.data-id=${spring.application.name}
nacos.config.type=properties

# Keycloak Configuration - Use environment variables
keycloak.auth-server-url=${KEYCLOAK_AUTH_SERVER_URL:http://localhost:8081}
keycloak.realm=${KEYCLOAK_REALM:klb-bank}
keycloak.resource=${KEYCLOAK_RESOURCE:account-service}
keycloak.customer.client-secret=${KEYCLOAK_CLIENT_SECRET:fwZ8y9q5ThqOXkcT7ZMromzbJfLLj5py}

keycloak.admin.username=${KEYCLOAK_ADMIN_USERNAME:admin}
keycloak.admin.password=${KEYCLOAK_ADMIN_PASSWORD:admin}
keycloak.admin.client-id=${KEYCLOAK_ADMIN_CLIENT_ID:admin-cli}

# Spring Security OAuth2 Configuration
spring.security.oauth2.resourceserver.jwt.issuer-uri=${keycloak.auth-server-url}/realms/${keycloak.realm}

# Account Service Business Configuration
account.checking.min-balance=${ACCOUNT_CHECKING_MIN_BALANCE:50000}
account.savings.min-balance=${ACCOUNT_SAVINGS_MIN_BALANCE:100000}
account.savings.default-interest-rate=${ACCOUNT_SAVINGS_DEFAULT_INTEREST_RATE:0.035}
account.savings.default-term=${ACCOUNT_SAVINGS_DEFAULT_TERM:6}
account.max-accounts-per-type=${ACCOUNT_MAX_ACCOUNTS_PER_TYPE:5}

# Resilience4j configuration for core calls
# Circuit Breakers
resilience4j.circuitbreaker.instances.core-open-account.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.core-open-account.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.core-open-account.sliding-window-size=20
resilience4j.circuitbreaker.instances.core-open-account.wait-duration-in-open-state=10s
resilience4j.circuitbreaker.instances.core-open-account.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.instances.core-open-account.automatic-transition-from-open-to-half-open-enabled=true

resilience4j.circuitbreaker.instances.core-close-account.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.core-close-account.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.core-close-account.sliding-window-size=20
resilience4j.circuitbreaker.instances.core-close-account.wait-duration-in-open-state=10s
resilience4j.circuitbreaker.instances.core-close-account.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.instances.core-close-account.automatic-transition-from-open-to-half-open-enabled=true

resilience4j.circuitbreaker.instances.core-deposit.failure-rate-threshold=50
resilience4j.circuitbreaker.instances.core-deposit.sliding-window-type=COUNT_BASED
resilience4j.circuitbreaker.instances.core-deposit.sliding-window-size=20
resilience4j.circuitbreaker.instances.core-deposit.wait-duration-in-open-state=10s
resilience4j.circuitbreaker.instances.core-deposit.permitted-number-of-calls-in-half-open-state=3
resilience4j.circuitbreaker.instances.core-deposit.automatic-transition-from-open-to-half-open-enabled=true

# Retries
resilience4j.retry.instances.core-open-account.max-attempts=3
resilience4j.retry.instances.core-open-account.wait-duration=250ms
resilience4j.retry.instances.core-open-account.retry-exceptions[0]=org.springframework.web.client.ResourceAccessException
resilience4j.retry.instances.core-open-account.retry-exceptions[1]=org.springframework.web.client.HttpServerErrorException
resilience4j.retry.instances.core-open-account.ignore-exceptions=org.springframework.web.client.HttpClientErrorException

resilience4j.retry.instances.core-close-account.max-attempts=3
resilience4j.retry.instances.core-close-account.wait-duration=250ms
resilience4j.retry.instances.core-close-account.retry-exceptions[0]=org.springframework.web.client.ResourceAccessException
resilience4j.retry.instances.core-close-account.retry-exceptions[1]=org.springframework.web.client.HttpServerErrorException
resilience4j.retry.instances.core-close-account.ignore-exceptions=org.springframework.web.client.HttpClientErrorException

resilience4j.retry.instances.core-deposit.max-attempts=3
resilience4j.retry.instances.core-deposit.wait-duration=250ms
resilience4j.retry.instances.core-deposit.retry-exceptions[0]=org.springframework.web.client.ResourceAccessException
resilience4j.retry.instances.core-deposit.retry-exceptions[1]=org.springframework.web.client.HttpServerErrorException
resilience4j.retry.instances.core-deposit.ignore-exceptions=org.springframework.web.client.HttpClientErrorException

# Time limiters
resilience4j.timelimiter.instances.core-open-account.timeout-duration=3s
resilience4j.timelimiter.instances.core-open-account.cancel-running-future=true

resilience4j.timelimiter.instances.core-close-account.timeout-duration=3s
resilience4j.timelimiter.instances.core-close-account.cancel-running-future=true

resilience4j.timelimiter.instances.core-deposit.timeout-duration=3s
resilience4j.timelimiter.instances.core-deposit.cancel-running-future=true
